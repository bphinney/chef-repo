rm -f /usr/bin/remote-update.sh
rm -f /var/log/remote-update.log
touch /usr/bin/remote-update.sh
touch /var/log/remote-update.log
chmod +x /usr/bin/remote-update.sh
echo '#Generated by /usr/bin/remote-update '$(date +%c) |tee -a /usr/bin/remote-update.sh
knife node list | grep -v chef- | xargs -I {} echo "ssh {} /usr/bin/yum-update -y >> /var/log/remote-update.log 2>&1" >> /usr/bin/remote-update.sh
echo "/usr/bin/yum-update -y >> /var/log/remote-update.log 2>&1" >> /usr/bin/remote-update.sh
echo "echo \"Update Complete! Log saved to /var/log/remote-update.log.\" >> /var/log/remote-update.log" >> /usr/bin/remote-update.sh
for updatesession in $(screen -ls | grep -o '[0-9]*\.remoteupdate'); do screen -S "${updatesession}" -X quit; done
screen -S remoteupdate -d -m bash /usr/bin/remote-update.sh
echo "Update process started!  Saving log to /var/log/remote-update.log..."
tail -f /var/log/remote-update.log | while read UPDATELOG
do
  echo "${UPDATELOG}"
  [[ "${UPDATELOG}" == *"Update Complete"* ]] && pkill -P $$ tail
done
